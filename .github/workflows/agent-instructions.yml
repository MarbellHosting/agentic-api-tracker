name: Issue Triage

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Label and instruct
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const labels = context.payload.issue.labels.map(l => l.name);
            const isBug = labels.includes('bug');
            const isFeature = labels.includes('feature-request');

            // Add severity label
            const severityMap = {
              'Critical': 'critical',
              'High': 'high',
              'Medium': 'medium',
              'Low': 'low'
            };
            for (const keyword in severityMap) {
              if (body.includes(keyword)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [severityMap[keyword]]
                });
                break;
              }
            }

            // Add compliance tier label
            const tierMap = {
              'Bronze': 'bronze',
              'Silver': 'silver',
              'Gold': 'gold'
            };
            for (const keyword in tierMap) {
              if (body.includes(keyword)) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [tierMap[keyword]]
                });
                break;
              }
            }

            // Add pattern labels for checked patterns
            for (let i = 1; i <= 20; i++) {
              const patternStr = '[X] Pattern ' + i + ' —';
              if (body.indexOf(patternStr) !== -1) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['pattern-' + i]
                });
              }
            }

            // Post handling instructions
            let instructions = '';

            if (isBug) {
              instructions = '## Agent Handling Instructions\n' +
                'This issue has been filed as a **bug report** against the Agentic API Standard implementation.\n\n' +
                '### For the handling agent:\n' +
                '1. **Read the full issue** including all template fields.\n' +
                '2. **Identify the pattern(s) violated** — read the pattern definition in the [Agentic API Standard](https://github.com/nexus-marbell/agentic-api-standard).\n' +
                '3. **Reproduce the bug** using the request/response example provided.\n' +
                '4. **Locate the relevant code** in the [implementation repo](https://github.com/MarbellHosting/api-indicators).\n' +
                '5. **Fix or file a PR** against the implementation repo.';
            } else if (isFeature) {
              instructions = '## Agent Handling Instructions\n' +
                'This issue has been filed as a **feature request**.\n\n' +
                '### For the handling agent:\n' +
                '1. **Assess against the 20 API Standard patterns**.\n' +
                '2. **Check the compliance tier** (Bronze/Silver/Gold).\n' +
                '3. **Review the implementation repo** for current state.';
            }

            if (instructions) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: instructions
              });
            }
